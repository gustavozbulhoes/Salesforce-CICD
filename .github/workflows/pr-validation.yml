on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      - 'force-app/**'

name: Validate Production Deploy

jobs:
  check_deployment:
    runs-on: ubuntu-latest
    name: Simulate Deployment to Major Org
    permissions:
      pull-requests: write
    env:
      SFDX_CLIENT_ID_MAIN: ${{secrets.SFDX_CLIENT_ID_MAIN}}
      SFDX_CLIENT_KEY_MAIN: ${{secrets.SFDX_CLIENT_KEY_MAIN}}
      SFDX_DEPLOY_WAIT_MINUTES: 120
      SFDX_TEST_WAIT_MINUTES: 120
      CI_COMMIT_REF_NAME: ${{github.event.pull_request.base.ref}}
      ORG_ALIAS: ${{github.event.pull_request.base.ref}}
      CONFIG_BRANCH: ${{github.event.pull_request.base.ref}}
      GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      FORCE_COLOR: "1"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: "18"

    - name: Selecting Tests to Run from PR Body
      run: |
        echo ${{github.event.pull_request.body}} > ./pr_body.txt
        node ./parsePR.js
        TESTS=$(cat testsToRun.txt)
        echo "APEX_TESTS=$TESTS" >> $GITHUB_ENV

    - name: Install Salesforce CLI And Git Delta
      run: |
        npm install --no-cache @salesforce/cli --global
        echo 'y' | sfdx plugins:install sfdx-git-delta

    - name: Install sfdx-hardis Plugin
      if: ${{env.APEX_TESTS == 'all'}}
      run: |
        sf plugins install @salesforce/plugin-packaging
        echo 'y' | sfdx plugins:install sfdx-hardis

    - name: Calculate delta
      run: |
        mkdir changed-sources
        sfdx sgd:source:delta --to "HEAD" --from "HEAD^" --output changed-sources/ --generate-delta --source force-app/
        echo $(cat changed-sources/package/package.xml) > manifest/package.xml

    - name: Salesforce Authentication
      run: |
        if [ "${{env.APEX_TESTS}}" == 'all' ]; then
          sfdx hardis:auth:login
        else
          echo ${{ secrets.AUTH_SECRET}} > ./AUTH_SECRET.txt
          sfdx auth:sfdxurl:store -f ./AUTH_SECRET.txt -s -a targetOrg
        fi

    - name: Simulate delta deployment
      run: |
        if [ "${{env.APEX_TESTS}}" == 'all' ]; then
          sfdx hardis:project:deploy:sources:dx -c
        else
          sfdx force:source:deploy -p "changed-sources/force-app" --checkonly --testlevel RunSpecifiedTests --runtests ${{env.APEX_TESTS}} --json
        fi

    - name: 'Check destructive changes (if any)'
      run: sfdx force:mdapi:deploy -d "changed-sources/destructiveChanges" --checkonly --ignorewarnings