# Add your major branches names here
# If you do, also add SFDX_CLIENT_ID / KEY variables in job step "Login & Simulate Deployment" below
on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
    paths:
      - 'force-app/**'

name: Validation SFDX Hardis

jobs:
  check_deployment:
    runs-on: ubuntu-latest
    name: Simulate Deployment to Major Org
    permissions:
      pull-requests: write
    steps:
    # Checkout repo
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Faster code checkout fetching only latest commit
    # Setup node
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: "18"
    # tests to run -> Ideia is use sfdx-hardis only for all tests and use in-house selected tests
    - name: 'Selecting Tests to Run from PR Body'
      env:
        PR_BODY: ${{github.event.pull_request.body}}Â´
      run: |
        echo $PR_BODY > ./pr_body.txt
        node ./parsePR.js   
        cat testsToRun.txt           
        TESTS=$(cat testsToRun.txt)       
        echo "APEX_TESTS=$TESTS" >> $GITHUB_ENV    
    # SFDX & plugins
    - name: Install SFDX and plugins
      run: |
        npm install --no-cache @salesforce/cli --global
        sf plugins install @salesforce/plugin-packaging
        echo 'y' | sfdx plugins:install sfdx-hardis
        echo 'y' | sfdx plugins:install sfdx-essentials
        echo 'y' | sfdx plugins:install sfdx-git-delta
        sf version --verbose --json
    # Login & check deploy with test classes & code coverage
    - name: Login & Simulate deployment
      env:
        SFDX_CLIENT_ID_MAIN: ${{ secrets.SFDX_CLIENT_ID_MAIN}}
        SFDX_CLIENT_KEY_MAIN: ${{ secrets.SFDX_CLIENT_KEY_MAIN}}
        SFDX_DEPLOY_WAIT_MINUTES: 120 # Override if necessary
        SFDX_TEST_WAIT_MINUTES: 120 # Override if necessary
        CI_COMMIT_REF_NAME: ${{ github.event.pull_request.base.ref }} # Defines the target branch of the PR
        ORG_ALIAS: ${{ github.event.pull_request.base.ref }} # Defines the target branch of the PR
        CONFIG_BRANCH: ${{ github.event.pull_request.base.ref }} # Defines the target branch of the PR
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        FORCE_COLOR: "1"
      run: |
        echo "Simulate SFDX deployment using Hardis against \"$CONFIG_BRANCH\""
        sfdx hardis:auth:login -d
        sfdx hardis:project:deploy:sources:dx --check